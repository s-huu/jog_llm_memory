This section of the repo contains codes for reproducing the WMDP experiment in our paper. This section of the repo reused code and data from [WMDP](https://github.com/centerforaisafety/wmdp)

## Dataset Preparation
Following instructions from [WMDP repo](https://github.com/centerforaisafety/wmdp), download the unlearn corpora and place it under `/data`.

## Unlearn

We provide 4 different unlearning configs, each for a different unlearning method. 

- Gradient Ascent: `unlearn_ga.yaml`
- Gradient Difference: `unlearn_gd.yaml`
- KL minimization: `unlearn_kl.yaml`
- NPO: `unlearn_npo.yaml`

As an example, to unlearn bio and cyber wmdp forget corpora with gradient ascent, run the following commands:
```
cd src
CUDA_VISIBLE_DEVICES=0,1 torchrun --nproc_per_node=2 --master_port=23579 unlearn.py --config-name=unlearn_ga.yaml
```

We also provide the code for RMU unlearning in `unlearn_rmu.py` which could be of independent interest and used to replicate our experiment in Appendix E.


## Relearn

First replace `model_path` in `config/relearn.yaml` to your unlearned model path. We provide an example model that is already unlearned using grad ascent. 

To perform relearning, we provide the relearn text, which is generated by GPT, in `data/relearn_knowledge_all_15.txt`. You are free to try out any relearn text by yourselves. Run the following command:
```
cd src
CUDA_VISIBLE_DEVICES=0,1 torchrun --nproc_per_node=2 --master_port=23579 relearn_full.py --config-name=relearn.yaml
```

## Evaluate

First run the following command to generate the answers from your model:
```
cd src
python generate_answers.py --model_path [YOUR MODEL PATH] --save_file [YOUR FILE NAME FOR ANSWERS]
```
We have provided an example model path and save file name using our relearned ckpt from the gradient ascent unlearning ckpt.

Then run the following to get the LLM-as-a-Judge score:
```
cd src
python gpt4_eval.py --answer_file [YOUR FILE NAME FOR ANSWERS] --open_ai_key [YOUR OPEN AI API PROJECT KEY] --save_file [YOUR FILE NAME FOR GPT RESPONSE]
```

Note that you would need a key for the OpenAI API to run the evaluation.
